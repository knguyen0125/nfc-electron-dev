require("source-map-support/source-map-support.js").install(),module.exports=function(e){var t={};function r(n){if(t[n])return t[n].exports;var o=t[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,r),o.l=!0,o.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)r.d(n,o,function(t){return e[t]}.bind(null,o));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=7)}([function(e,t){e.exports=require("electron")},function(e,t){e.exports=require("@taptrack/ndef")},function(e,t){e.exports=require("util")},function(e,t){e.exports=require("path")},function(e,t){e.exports=require("url")},function(e,t){e.exports=require("nfc-pcsc")},function(e,t){e.exports=require("events")},function(e,t,r){e.exports=r(8)},function(e,t,r){"use strict";r.r(t);var n=r(0),o=r(3),s=r(4),a=r(5),i=r(1),l=r.n(i),c=r(6),d=r.n(c);function u(e){return e.then(e=>[null,e]).catch(e=>[e])}var h=r(2);class w extends d.a{static get LOCK_PAGE(){return 2}static get CAPABILITY_CONTAINER_PAGE(){return 3}static get DATA_START_PAGE(){return 4}static get BLOCK_SIZE(){return 4}setAllowRead(e){return Object(h.isBoolean)(e)&&(this.allowRead=e),this.allowRead}setAllowWrite(e){return Object(h.isBoolean)(e)&&(this.allowWrite=e),this.allowWrite}setAllowWriteReadonly(e){return Object(h.isBoolean)(e)&&(this.allowWriteReadonly=e),this.allowWriteReadonly}setMessage(e){return this.message=e,this.message}constructor(){super(),this.nfc=null,this.readers=null,this.allowRead=!1,this.allowWrite=!1,this.allowWriteReadonly=!1,this.message=null,this.init()}init(){this.nfc=new a.NFC,this.readers=[],this.setAllowRead(!1),this.setAllowWrite(!1),this.setAllowWriteReadonly(!1),this.setMessage(null)}startDefault(){return this.start(this.readerHandler),this}start(e){return e=e.bind(this),this.nfc.on("reader",e),this.nfc.on("error",e=>{this.emit("nfc-error",e)}),this}async readerHandler(e){e.on("card",async()=>{const[t,r]=await u(this.handleCard(e));return t?this.emit("operation-complete",t.message):this.emit("operation-complete",r),r}),this.readers.push(e),this.emit("readerconn"),e.on("error",e=>{this.emit("reader-error",e)}),e.on("end",()=>{delete this.readers[this.readers.indexOf(e)],this.emit("readerend")})}async handleCard(e){const t={};let r=!1;if(this.allowRead){const[r,n]=await u(this.readCard(e));t.read=r?{error:r.message}:n}if(this.allowWrite){const[n,o]=await u(this.writeCard(e));n?(t.write={error:n.message},r=!0):t.write=o}if(!r&&this.allowWriteReadonly){const[r,n]=await u(this.writeReadOnly(e));t.readOnly=r?{error:r.message}:n}return t}async readHeader(e){const[t,r]=await u(e.read(w.CAPABILITY_CONTAINER_PAGE,w.BLOCK_SIZE));if(t)throw new Error("Error Reading tag");return{isValid:225===r[0],maxLength:8*r[2],majorVersion:(15&r[1])>>4,minorVersion:15&r[1],isReadOnly:15==(15&r[3])}}async readCard(e){const[t,r]=await u(this.readHeader(e));if(t)throw new Error(t);const n={"access-level":"",records:[]};if(!r.isValid)throw new Error("Tag is invalid");{r.isReadOnly?n["access-level"]="Read-only":n["access-level"]="Read-Write";const[o,s]=await u(e.read(w.DATA_START_PAGE,r.maxLength));if(o)throw new Error(o);const a=l.a.Message.fromBytes(s).getRecords();for(let e=0;e<a.length;e+=1){const r=a[e];try{const{content:e}=l.a.Utils.resolveTextRecord(r);n.records.push(e)}catch(t){}}}return n}async writeCard(e){const[t,r]=await u(this.readHeader(e));if(t)throw new Error(t);if(r.isReadOnly)throw new Error("Tag is Read-only, cannot write");if(r.isValid){if(null===this.message)throw new Error("No Message set.");const t=l.a.Utils.createTextRecord(this.message),n=new l.a.Message([t]),o=this.constructor.constructMessageNDEF(n.toByteArray(),r.maxLength),[s]=await u(e.write(w.DATA_START_PAGE,o));if(s)throw new Error("Error Writing to Tag");return!0}throw new Error("Malformed Tag header")}async writeReadOnly(e){const[t,r]=await u(e.read(w.LOCK_PAGE,w.BLOCK_SIZE));if(t)throw new Error("Error Reading Tag");r.set([255,255],2);const[n,o]=await u(e.read(w.CAPABILITY_CONTAINER_PAGE,w.BLOCK_SIZE));if(n)throw new Error("Error Reading Tag");const s=[15|o[3]];o.set(s,3);const a=new Uint8Array(8);a.set(r,0),a.set(o,4);const[i]=await u(e.write(w.LOCK_PAGE,a));if(i)throw new Error("Error writing readonly information to tag");return!0}static constructMessageNDEF(e,t,r=4){let n=2+e.length+1;n+=4,n-=n%r;let o=!1;if(e.length>254&&(o=!0,n+=2),n>t)throw new Error("Length of Message is larger than supported");const s=new Uint8Array(n);return s.fill(0),s.set([3]),o?(s.set([255],1),s.set([Math.floor(e.length/256)],2),s.set([e.length%256],3),s.set(e,4),s.set([254],4+e.length)):(s.set([e.length],1),s.set(e,2),s.set([254],2+e.length)),s}}const f=!1;let p,g;function m(){const e=new n.BrowserWindow({height:800,width:800});return f&&e.webContents.openDevTools(),f?e.loadURL(`http://localhost:${process.env.ELECTRON_WEBPACK_WDS_PORT}`):e.loadURL(Object(s.format)({pathname:o.join(__dirname,"index.html"),protocol:"file",slashes:!0})),e.on("closed",()=>{p=null,g=null}),e.webContents.on("devtools-opened",()=>{e.focus(),setImmediate(()=>{e.focus()})}),e}function y(){const e=new w;e.startDefault(),e.on("operation-complete",e=>{console.log(e),p.webContents.send("operation-complete",e)}),n.ipcMain.on("set-read",(t,r)=>{console.log("read",r),e.setAllowRead(r)}),n.ipcMain.on("set-write",(t,r)=>{console.log("write",r),e.setAllowWrite(r)}),n.ipcMain.on("set-write-readonly",(t,r)=>{console.log("readonly",r),e.setAllowWriteReadonly(r)}),n.ipcMain.on("set-permission",(t,r)=>{console.log("perm",r),e.setAllowRead(r[0]),e.setAllowWrite(r[1]),e.setAllowWriteReadonly(r[2])}),n.ipcMain.on("set-message",(t,r)=>{console.log("msg",r),e.setMessage(r)})}n.app.on("window-all-closed",()=>{"darwin"!==process.platform&&n.app.quit()}),n.app.on("activate",()=>{null===p&&(p=m()),null===g&&(g=y())}),n.app.on("ready",()=>{p=m(),g=y()})}]);
//# sourceMappingURL=main.js.map